<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>notrack.link</title>
		<style>
			.hop-info {
				margin-top: 1.5em;
			}
			.hop-info .hop-info-error {
			}
		</style>
	</head>
	<body>
		<h1 id="main-title">notrack.link</h1>
		<div id="results">
			<p>hi! this site follows links for you and removes crappy tracking parameters.</p>
			<p>simply put any link after the domain name, like: <code>https://notrack.link/https://foo.bar</code></p>
		</div>
		<script async>
			const currentHost = window.location.host;
			const hostStrIdx = window.location.href.indexOf(currentHost);
			const unparsedPath = window.location.href.slice(hostStrIdx + currentHost.length + 1 /* trim "/" */);
			if (URL.canParse(unparsedPath)) {
				document.getElementById('results').innerHTML = '';
				document.getElementById('main-title').innerText = 'following link...';
				const h = new EventSource(`/iterhops/${unparsedPath}`);
				h.addEventListener('error', (err) => {
					h.close();
					const line = document.createElement('div');
					line.classList.add('hop-info', 'hop-info-error');
					const errspan = document.createElement('span');
					errspan.style = 'color: red; font-weight: bold';
					errspan.innerText = 'error: ';
					line.appendChild(errspan);
					const text = document.createElement('span');
					text.innerText = `failed to connect to backend (did an ad blocker interfere? it can get confused with links that do tracking.)`;
					line.appendChild(text);
					document.getElementById('results').appendChild(line);
				});
				h.addEventListener('hop_error', (data) => {
					h.close();
					const errorInfo = JSON.parse(data.data);
					const line = document.createElement('div');
					line.classList.add('hop-info', 'hop-info-error');
					const text = document.createElement('div');
					text.innerText = `error: ${errorInfo.message}`;
					line.appendChild(text);
					document.getElementById('results').appendChild(line);
				});
				h.addEventListener('hop', (data) => {
					const hopInfo = JSON.parse(data.data);
					if (hopInfo.final) {
						h.close();
						setTimeout(() => {
							// window.location.href = hopInfo.cleanedLocation || hopInfo.location;
						}, 1000);
					}
					const line = document.createElement('div');
					line.classList.add('hop-info');
					const text = document.createElement('div');
					text.innerText = `(${hopInfo.seq}) hop`;
					line.appendChild(text);
					const link = document.createElement('a');
					link.rel = 'noopener noreferrer nofollow';
					const cleanedLinkDiffer = hopInfo.final ? !!hopInfo.cleanedLocation : false;
					link.href = hopInfo.cleanedLocation || hopInfo.location;
					link.innerText = hopInfo.cleanedLocation || hopInfo.location;
					line.appendChild(link);
					if (hopInfo.error) {
						const errBox = document.createElement('div');
						const errspan = document.createElement('span');
						errspan.style = 'color: red; font-weight: bold';
						errspan.innerText = 'error: ';
						errBox.appendChild(errspan);
						errBox.append(hopInfo.error);
						line.appendChild(errBox);
					}
					if (cleanedLinkDiffer) {
						const s = document.createElement('span');
						s.innerHTML = '<br />(link trackers removed)';
						line.appendChild(s);
					}
					document.getElementById('results').appendChild(line);
				});
			}
		</script>
	</body>
</html>
